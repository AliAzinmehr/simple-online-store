<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ† | SIMPLE SHOP</title>

  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Google Fonts: Vazirmatn + Yekan Bakh -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&family=Yekan+Bakh:wght@400;600;800&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #6c5ce7;
      --primary-dark: #5f3dc4;
      --success: #00b894;
      --danger: #d63031;
      --light: #f8f9fa;
      --dark: #2d3436;
      --gray: #b2bec3;
    }

    * { font-family: 'Vazirmatn', 'Yekan Bakh', Tahoma, sans-serif; }

    body {
      background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      min-height: 100vh;
      padding: 0;
      margin: 0;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .navbar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .navbar-brand {
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--primary);
    }

    .nav-link {
      font-weight: 500;
      color: var(--dark);
      transition: all 0.3s;
    }

    .nav-link:hover {
      color: var(--primary);
    }

    .sidebar {
      min-width: 260px;
      max-width: 260px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-left: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      height: 100vh;
      position: sticky;
      top: 0;
      animation: slideInRight 0.5s ease-out;
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .sidebar .nav-link {
      border-radius: 1rem;
      margin: 8px 12px;
      padding: 10px 15px;
      color: var(--dark);
      font-size: 0.95rem;
    }

    .sidebar .nav-link.active {
      background: var(--primary);
      color: white;
    }

    .sidebar .nav-link:hover:not(.active) {
      background: rgba(108, 92, 231, 0.1);
      color: var(--primary);
    }

    .content {
      flex: 1;
      padding: 2rem;
    }

    .hero {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-radius: 1.5rem;
      padding: 3rem;
      text-align: center;
      margin-bottom: 2rem;
      animation: fadeInUp 0.7s ease-out;
    }

    .product-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-radius: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
      overflow: hidden;
    }

    .product-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }

    .product-img {
      height: 200px;
      object-fit: cover;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-radius: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 1.5rem;
      animation: fadeInUp 0.7s ease-out;
    }

    .cart-floating {
      position: fixed;
      bottom: 30px;
      left: 30px;
      background: var(--primary);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 20px rgba(108, 92, 231, 0.4);
      transition: all 0.3s;
      z-index: 1000;
    }

    .cart-floating:hover {
      transform: scale(1.1);
    }

    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      font-size: 0.7rem;
    }

    .table {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-radius: 1.5rem;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border: none;
      border-radius: 1rem;
      padding: 0.75rem 1.5rem;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(108, 92, 231, 0.4);
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-radius: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .form-control {
      border-radius: 1rem;
      border: 1.5px solid #ddd;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
    }

    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.2rem rgba(108, 92, 231, 0.25);
    }

    .offcanvas {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 992px) {
      .sidebar { display: none; }
      .content { padding: 1rem; }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">ğŸ›’ SIMPLE SHOP</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-center">
          <li class="nav-item"><a class="nav-link active" href="#" id="navHome">Ø®Ø§Ù†Ù‡</a></li>
          <li class="nav-item"><a class="nav-link" href="#" id="navProductsLink">Ù…Ø­ØµÙˆÙ„Ø§Øª</a></li>
          <li class="nav-item d-none" id="navOrdersNav"><a class="nav-link" href="#" id="navOrders">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <span id="welcomeUser"></span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="logoutBtn">Ø®Ø±ÙˆØ¬</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="d-flex">
    <!-- Sidebar (Admin) -->
    <div class="sidebar d-none" id="adminSidebar">
      <div class="p-4">
        <h6 class="text-muted">Ù…Ø¯ÛŒØ±ÛŒØª</h6>
        <ul class="nav nav-pills flex-column mt-3">
          <li class="nav-item mb-2"><a class="nav-link active" href="#" id="navDashboard"><i class="bi bi-speedometer2 me-2"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
          <li class="nav-item mb-2"><a class="nav-link" href="#" id="navAdminProducts"><i class="bi bi-box-seam me-2"></i> Ù…Ø­ØµÙˆÙ„Ø§Øª</a></li>
          <li class="nav-item mb-2"><a class="nav-link" href="#" id="navAdminOrders"><i class="bi bi-cart-check me-2"></i> Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</a></li>
        </ul>
      </div>
    </div>

    <!-- Main Content -->
    <div class="content">
      <!-- Hero (Customer) -->
      <div class="hero d-none" id="heroSection">
        <h1 class="display-5 fw-bold">Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù…Ø§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</h1>
        <p class="lead">Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø§ Ø¨Ù‡ØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øª</p>
        <button class="btn btn-primary" id="shopNowBtn">Ø´Ø±ÙˆØ¹ Ø®Ø±ÛŒØ¯</button>
      </div>

      <!-- Customer Products -->
      <div id="customerView">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3>Ù…Ø­ØµÙˆÙ„Ø§Øª</h3>
          <input type="text" class="form-control w-auto" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." id="searchInput">
        </div>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="productsContainer"></div>
      </div>

      <!-- Admin Dashboard -->
      <div id="adminView" class="d-none">
        <div class="row mb-4" id="statsRow"></div>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø­ØµÙˆÙ„Ø§Øª</h5>
          <div>
            <button class="btn btn-primary me-2" id="openAddProduct"><i class="bi bi-plus-lg"></i> Ø§ÙØ²ÙˆØ¯Ù†</button>
            <button class="btn btn-outline-secondary" id="refreshProducts"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-primary">
              <tr>
                <th>#</th><th>ØªØµÙˆÛŒØ±</th><th>Ù†Ø§Ù…</th><th>Ù‚ÛŒÙ…Øª</th><th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th><th>Ø¯Ø³ØªÙ‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
              </tr>
            </thead>
            <tbody id="productsTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Cart -->
  <div class="cart-floating d-none" id="cartFloating" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
    <i class="bi bi-cart3 fs-4"></i>
    <span class="badge bg-danger rounded-pill cart-badge" id="cartCount">0</span>
  </div>

  <!-- Cart Offcanvas -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body" id="cartItems">
      <p class="text-muted">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</p>
    </div>
    <div class="offcanvas-footer p-3 border-top d-none" id="cartFooter">
      <div class="d-flex justify-content-between mb-2">
        <strong>Ø¬Ù…Ø¹ Ú©Ù„:</strong>
        <strong id="cartTotal">Û° ØªÙˆÙ…Ø§Ù†</strong>
      </div>
      <button class="btn btn-success w-100" id="checkoutBtn">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="addProductForm">
          <div class="modal-header">
            <h5 class="modal-title">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„</label>
              <input id="p_name" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)</label>
              <input id="p_price" type="number" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ</label>
              <input id="p_stock" type="number" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
              <input id="p_category" class="form-control" />
            </div>
            <div class="mb-3">
              <label class="form-label">Ù„ÛŒÙ†Ú© ØªØµÙˆÛŒØ±</label>
              <input id="p_image" class="form-control" placeholder="https://example.com/image.jpg" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ù„ØºÙˆ</button>
            <button type="submit" class="btn btn-primary">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role') || 'customer';
    const userName = localStorage.getItem('userName') || 'Ù…Ù‡Ù…Ø§Ù†';
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');

    // Elements
    const welcomeUser = document.getElementById('welcomeUser');
    const adminView = document.getElementById('adminView');
    const customerView = document.getElementById('customerView');
    const adminSidebar = document.getElementById('adminSidebar');
    const heroSection = document.getElementById('heroSection');
    const productsContainer = document.getElementById('productsContainer');
    const productsTbody = document.getElementById('productsTbody');
    const statsRow = document.getElementById('statsRow');
    const cartFloating = document.getElementById('cartFloating');
    const cartCount = document.getElementById('cartCount');
    const cartItems = document.getElementById('cartItems');
    const cartFooter = document.getElementById('cartFooter');
    const cartTotal = document.getElementById('cartTotal');

    welcomeUser.innerText = userName;

    if (!token) {
      location.href = 'login.html';
    }

    // API Helper
    const api = (path, opts = {}) => {
      opts.headers = opts.headers || {};
      opts.headers['Content-Type'] = 'application/json';
      opts.headers['Authorization'] = 'Bearer ' + token;
      return fetch(path, opts).then(r => r.json().then(d => ({ ok: r.ok, data: d })).catch(() => ({ ok: false })));
    };

    // Logout
    document.getElementById('logoutBtn').onclick = async () => {
      try { await fetch('/api/logout', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } }); } catch {}
      localStorage.clear();
      location.href = 'login.html';
    };

    // Role-based UI
    if (role === 'admin') {
      adminSidebar.classList.remove('d-none');
      adminView.classList.remove('d-none');
      customerView.classList.add('d-none');
      document.getElementById('navOrdersNav').classList.remove('d-none'); // Ø§Ø¯Ù…ÛŒÙ†
      loadAdminDashboard();
    } else {
      heroSection.classList.remove('d-none');
      cartFloating.classList.remove('d-none');
      document.getElementById('navOrdersNav').classList.remove('d-none'); // Ù…Ø´ØªØ±ÛŒ Ù‡Ù… Ø¨Ø¨ÛŒÙ†Ù‡
      loadCustomerProducts();
      updateCart();
    }

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† Ø¯Ø± <script>
document.getElementById('navOrders').onclick = async () => {
  const res = await api('/api/dashboard');
  if (res.ok && res.data.role === 'customer') {
    showCustomerOrders(res.data.orders);
  }
};

function showCustomerOrders(orders) {
  customerView.innerHTML = `
    <h3 class="mb-4">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§</h3>
    ${orders.length ? `
      <div class="table-responsive">
        <table class="table table-hover">
          <thead><tr><th>#</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ù…Ø¨Ù„Øº</th><th>ÙˆØ¶Ø¹ÛŒØª</th></tr></thead>
          <tbody>
            ${orders.map(o => `
              <tr>
                <td>${o.id}</td>
                <td>${new Date(o.order_date).toLocaleDateString('fa-IR')}</td>
                <td>${o.total_price.toLocaleString()} ØªÙˆÙ…Ø§Ù†</td>
                <td><span class="badge bg-${o.status === 'completed' ? 'success' : 'warning'}">${o.status || 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´'}</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    ` : '<p class="text-muted">Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>'}
  `;
}

    // Load Customer Products
    async function loadCustomerProducts() {
      const res = await api('/api/products');
      if (res.ok) renderCustomerProducts(res.data);
    }

    function renderCustomerProducts(products) {
  const container = document.getElementById('productsContainer');
  container.innerHTML = '';

  products.forEach(p => {
    const col = document.createElement('div');
    col.className = 'col';

    col.innerHTML = `
      <div class="card product-card h-100">
        <img src="${p.image_url || 'https://via.placeholder.com/300'}" class="product-img" alt="${p.name}">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">${p.name}</h5>
          <p class="text-muted small">${p.category || 'Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡'}</p>
          <div class="mt-auto">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <strong class="text-primary fs-5">${Number(p.price).toLocaleString()} ØªÙˆÙ…Ø§Ù†</strong>
              <span class="badge ${p.stock>0 ? 'bg-success' : 'bg-danger'} fs-6">
                ${p.stock > 0 ? p.stock + ' Ù…ÙˆØ¬ÙˆØ¯' : 'Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯'}
              </span>
            </div>
            <button class="btn btn-primary w-100">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª</button>
          </div>
        </div>
      </div>`;

    // Ø§ÛŒÙ† Ø¯Ùˆ Ø®Ø· Ù…Ù‡Ù… Ù‡Ø³ØªÙ† â€” Ø¬Ù„Ø³Ù‡ Û¶
    col.style.cursor = 'pointer';                    // Ù…ÙˆØ³ Ø¯Ø³Øª Ù…ÛŒØ´Ù‡
    col.onclick = () => showProductDetail(p.id);     // Ú©Ù„ÛŒÚ© â†’ Ø¬Ø²Ø¦ÛŒØ§Øª

    container.appendChild(col);
  });
}

      document.querySelectorAll('.btn-add-cart').forEach(btn => {
        btn.onclick = () => addToCart(btn.dataset.id);
      });
    

    // Cart Functions
    function addToCart(productId) {
      const product = productsContainer.querySelector(`.btn-add-cart[data-id="${productId}"]`).closest('.col');
      const name = product.querySelector('.card-title').innerText;
      const price = parseInt(product.querySelector('.text-primary').innerText.replace(/[^0-9]/g, ''));
      const img = product.querySelector('img').src;

      const existing = cart.find(i => i.id == productId);
      if (existing) {
        existing.qty += 1;
      } else {
        cart.push({ id: productId, name, price, img, qty: 1 });
      }
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
      showAlert('Ø¨Ù‡ Ø³Ø¨Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!', 'success');
    }

    function updateCart() {
      cartCount.innerText = cart.reduce((s, i) => s + i.qty, 0);
      renderCartItems();
    }

    function renderCartItems() {
      if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-muted">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</p>';
        cartFooter.classList.add('d-none');
        return;
      }
      cartItems.innerHTML = '';
      let total = 0;
      cart.forEach((item, idx) => {
        total += item.price * item.qty;
        const div = document.createElement('div');
        div.className = 'd-flex align-items-center mb-3 pb-3 border-bottom';
        div.innerHTML = `
          <img src="${item.img}" class="rounded me-3" style="width:60px;height:60px;object-fit:cover;">
          <div class="flex-grow-1">
            <h6 class="mb-1">${item.name}</h6>
            <small class="text-muted">${item.price.toLocaleString()} ØªÙˆÙ…Ø§Ù† Ã— ${item.qty}</small>
          </div>
          <button class="btn btn-sm btn-danger btn-remove-cart" data-idx="${idx}">Ø­Ø°Ù</button>`;
        cartItems.appendChild(div);
      });
      cartTotal.innerText = total.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
      cartFooter.classList.remove('d-none');

      document.querySelectorAll('.btn-remove-cart').forEach(b => {
        b.onclick = () => {
          cart.splice(b.dataset.idx, 1);
          localStorage.setItem('cart', JSON.stringify(cart));
          updateCart();
        };
      });
    }

    document.getElementById('checkoutBtn').onclick = async () => {
      if (cart.length === 0) return;
      const res = await api('/api/orders', {
        method: 'POST',
        body: JSON.stringify({ items: cart })
      });
      if (res.ok) {
        showAlert('Ø³ÙØ§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!', 'success');
        localStorage.removeItem('cart');
        cart = [];
        updateCart();
      } else {
        showAlert(res.data?.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´', 'danger');
      }
    };

    // Admin Dashboard
    async function loadAdminDashboard() {
      const res = await api('/api/dashboard');
      if (res.ok) {
        renderStats(res.data.stats);
        renderAdminProducts(res.data.products || []);
      }
    }

    function renderStats(stats) {
      statsRow.innerHTML = `
        <div class="col-md-4 mb-3">
          <div class="stat-card">
            <div class="d-flex align-items-center">
              <i class="bi bi-box-seam text-primary fs-2 me-3"></i>
              <div>
                <h6 class="text-muted">Ù…Ø­ØµÙˆÙ„Ø§Øª</h6>
                <h3 class="mb-0">${stats.productCount || 0}</h3>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="stat-card">
            <div class="d-flex align-items-center">
              <i class="bi bi-cart-check text-success fs-2 me-3"></i>
              <div>
                <h6 class="text-muted">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</h6>
                <h3 class="mb-0">${stats.orderCount || 0}</h3>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="stat-card">
            <div class="d-flex align-items-center">
              <i class="bi bi-currency-exchange text-warning fs-2 me-3"></i>
              <div>
                <h6 class="text-muted">Ø¯Ø±Ø¢Ù…Ø¯ Ú©Ù„</h6>
                <h3 class="mb-0">${(stats.totalRevenue || 0).toLocaleString()} ØªÙˆÙ…Ø§Ù†</h3>
              </div>
            </div>
          </div>
        </div>`;
    }

    function renderAdminProducts(list) {
      productsTbody.innerHTML = '';
      if (!list.length) {
        productsTbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Ù…Ø­ØµÙˆÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
        return;
      }
      list.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.id}</td>
          <td><img src="${p.image_url || 'https://via.placeholder.com/50'}" class="rounded" style="width:50px;height:50px;object-fit:cover;"></td>
          <td>${p.name}</td>
          <td>${p.price.toLocaleString()}</td>
          <td><span class="badge ${p.stock > 0 ? 'bg-success' : 'bg-danger'}">${p.stock}</span></td>
          <td>${p.category || '-'}</td>
          <td>
            <button class="btn btn-sm btn-danger btn-delete" data-id="${p.id}">Ø­Ø°Ù</button>
          </td>`;
        productsTbody.appendChild(tr);
      });

      document.querySelectorAll('.btn-delete').forEach(b => {
        b.onclick = async () => {
          if (!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
          const res = await fetch('/api/admin/products/' + b.dataset.id, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (res.ok) {
            showAlert('Ù…Ø­ØµÙˆÙ„ Ø­Ø°Ù Ø´Ø¯', 'success');
            location.reload();
          } else {
            showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù', 'danger');
          }
        };
      });
    }

    // Add Product Modal
    const addModal = new bootstrap.Modal('#addProductModal');
    document.getElementById('openAddProduct').onclick = () => addModal.show();
    document.getElementById('addProductForm').onsubmit = async (e) => {
      e.preventDefault();
      const payload = {
        name: document.getElementById('p_name').value.trim(),
        price: +document.getElementById('p_price').value,
        stock: +document.getElementById('p_stock').value,
        category: document.getElementById('p_category').value.trim() || null,
        image_url: document.getElementById('p_image').value.trim() || null
      };
      const res = await fetch('/api/admin/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        addModal.hide();
        showAlert('Ù…Ø­ØµÙˆÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
        location.reload();
      } else {
        const j = await res.json();
        showAlert(j.message || 'Ø®Ø·Ø§', 'danger');
      }
    };

    // Navigation
    document.getElementById('navHome').onclick = () => location.reload();
    document.getElementById('shopNowBtn').onclick = () => window.scrollTo(0, document.getElementById('customerView').offsetTop);
    document.getElementById('refreshProducts').onclick = () => location.reload();

    // Alert Function
    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show fixed-top mx-auto mt-3`;
      alertDiv.style.maxWidth = '400px';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), 3000);
    }

    

  </script>

  <!-- Modal: Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„ (Ø¨Ù‡â€ŒØ±ÙˆØ²Ø´Ø¯Ù‡ Ø¨Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³) -->
<div class="modal fade" id="addProductModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="addProductForm" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ *</label>
            <input type="text" id="p_name" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
            <textarea id="p_description" class="form-control" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†) *</label>
            <input type="number" id="p_price" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ</label>
            <input type="number" id="p_stock" class="form-control" value="1" />
          </div>
          <div class="mb-3">
            <label class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
            <input type="text" id="p_category" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù„Ù¾â€ŒØªØ§Ù¾ØŒ Ù…ÙˆØ¨Ø§ÛŒÙ„" />
          </div>
          <div class="mb-3">
            <label class="form-label">Ø¹Ú©Ø³ Ù…Ø­ØµÙˆÙ„</label>
            <input type="file" id="p_image" class="form-control" accept="image/*" />
            <div class="form-text">Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª - ÙØ±Ù…Øª: JPG, PNG, WebP</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ù„ØºÙˆ</button>
          <button type="submit" class="btn btn-primary">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„</button>
        </div>
      </form>
    </div>
  </div>
</div>

  <script>
    // Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… Ø¨Ø§ FormData (Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„)
document.getElementById('addProductForm').onsubmit = async (e) => {
  e.preventDefault();
  const formData = new FormData();
  formData.append('name', document.getElementById('p_name').value.trim());
  formData.append('description', document.getElementById('p_description').value.trim());
  formData.append('price', document.getElementById('p_price').value);
  formData.append('stock', document.getElementById('p_stock').value || 1);
  formData.append('category', document.getElementById('p_category').value.trim());
  const fileInput = document.getElementById('p_image');
  if (fileInput.files[0]) formData.append('image', fileInput.files[0]);

  const res = await fetch('/api/admin/products', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + token },
    body: formData
  });

  const data = await res.json();
  if (res.ok) {
    addModal.hide();
    showAlert('Ù…Ø­ØµÙˆÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!', 'success');
    loadAdminDashboard();
  } else {
    showAlert(data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„', 'danger');
  }
};
  </script>

  <!-- ØµÙØ­Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø­ØµÙˆÙ„ (Ù…Ø´ØªØ±ÛŒ) -->
<div id="productDetailView" class="d-none container py-5">
  <div class="row">
    <div class="col-md-6">
      <img id="detailImage" class="img-fluid rounded shadow" style="max-height: 500px; object-fit: cover;" />
    </div>
    <div class="col-md-6">
      <h2 id="detailName"></h2>
      <p class="text-muted" id="detailCategory"></p>
      <p id="detailDescription" class="lead"></p>
      <div class="d-flex align-items-center mb-3">
        <h3 class="text-primary me-3" id="detailPrice"></h3>
        <span class="badge bg-success fs-6" id="detailStock"></span>
      </div>
      <button class="btn btn-primary btn-lg" id="addToCartBtn">
        Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
      </button>
      <button class="btn btn-outline-secondary btn-lg me-2" onclick="history.back()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>
  </div>
</div>

<script>
  // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø­ØµÙˆÙ„
async function showProductDetail(id) {
  customerView.classList.add('d-none');
  document.getElementById('productDetailView').classList.remove('d-none');
  const res = await api(`/api/products/${id}`);
  if (!res.ok) return showAlert('Ù…Ø­ØµÙˆÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯', 'danger');

  const p = res.data;
  document.getElementById('detailImage').src = p.image_url || 'https://via.placeholder.com/500';
  document.getElementById('detailName').innerText = p.name;
  document.getElementById('detailCategory').innerText = p.category || 'Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡';
  document.getElementById('detailDescription').innerText = p.description || 'ØªÙˆØ¶ÛŒØ­Ø§ØªÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.';
  document.getElementById('detailPrice').innerText = Number(p.price).toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
  document.getElementById('detailStock').innerText = p.stock > 0 ? `${p.stock} Ø¹Ø¯Ø¯ Ù…ÙˆØ¬ÙˆØ¯` : 'Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯';
  document.getElementById('detailStock').className = p.stock > 0 ? 'badge bg-success' : 'badge bg-danger';

  document.getElementById('addToCartBtn').onclick = () => {
    addToCart(p.id, p.name, p.price, p.image_url || 'https://via.placeholder.com/300');
    showAlert('Ø¨Ù‡ Ø³Ø¨Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!', 'success');
  };
}
</script>

</body>
</html>